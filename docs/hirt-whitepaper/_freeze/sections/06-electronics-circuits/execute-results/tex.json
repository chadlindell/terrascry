{
  "hash": "2d90955ef7ed91f771734ebf824080ce",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Electronics & Circuits\"\n---\n\n## Overview {#sec-electronics-overview}\n\nThis section consolidates all circuit designs for the HIRT system, including the MIT (Magneto-Inductive Tomography) circuits, ERT (Electrical Resistivity Tomography) circuits, and base hub electronics. The design uses **centralized electronics with passive probes**: all active components reside in the surface hub, while probes contain only coils and electrodes.\n\nThis architecture offers significant advantages: lower per-probe cost, easier maintenance, better reliability (passive probes are more robust), centralized firmware updates, and simplified probe construction. The trade-off is increased cabling complexity for the multi-probe harness.\n\n::: {.callout-tip}\n## Hardware Documentation Reference\n\nComplete circuit schematics and detailed design notes are maintained in the hardware documentation:\n\n- **MIT Circuit:** `/hardware/schematics/electronics/mit-circuit.md` - Full TX/RX chain design with component values\n- **ERT Circuit:** `/hardware/schematics/electronics/ert-circuit.md` - Howland current source and measurement circuits\n- **Base Hub Circuit:** `/hardware/schematics/electronics/base-hub-circuit.md` - Central hub electronics integration\n- **Block Diagrams:** `/hardware/schematics/electronics/probe-electronics-block.md` - System-level block diagrams\n\nThe diagrams in this section provide conceptual overviews; refer to the hardware schematics for exact component values and PCB layout guidance.\n:::\n\n## System Block Diagram {#sec-system-block}\n\n\n\nThe central hub contains: (1) MCU for control and DSP, (2) MIT transmitter chain (DDS + power driver), (3) MIT receiver chain (preamp + instrumentation amplifier + ADC), (4) ERT current source and voltage measurement, and (5) high-density analog multiplexers. These connect via DB25 trunk cables to passive **Zone Hubs**, which then distribute signals to individual probes.\n\n## MIT Transmit (TX) Chain {#sec-mit-tx}\n\n\n\n## DDS Sine Generator {#sec-dds}\n\nThe transmit chain begins with a Direct Digital Synthesis (DDS) generator, the AD9833. This IC generates precise sine waves from 0.1 Hz to 12.5 MHz with 28-bit frequency resolution. For HIRT, the operating range is 2-50 kHz, with lower frequencies (2-10 kHz) preferred for deeper penetration.\n\n| Parameter | Specification |\n|-----------|---------------|\n| Part Number | AD9833BRMZ |\n| Frequency Range | 0.1 Hz to 12.5 MHz |\n| Output Level | 0.6 V RMS sine wave |\n| Interface | SPI (10 MHz max) |\n| Resolution | 28-bit frequency, 12-bit phase |\n| Power Supply | 2.3-5.5V, 3 mA typical |\n\n: AD9833 DDS Generator Specifications. {#tbl-dds-specs}\n\n## TX Power Driver {#sec-tx-driver}\n\nThe DDS output is amplified by an OPA454 or OPA2277 operational amplifier configured as a non-inverting amplifier. The gain is set by external resistors to provide 2-10x amplification, delivering 10-50 mA into the TX coil at 0-5 V RMS. The driver bandwidth (2.5 MHz) easily accommodates the operating frequency range.\n\n| Parameter | OPA454 | OPA2277 |\n|-----------|--------|---------|\n| Gain (configurable) | 2-10x | 2-10x |\n| Output Current | +/-2.5 A peak | +/-20 mA |\n| Bandwidth | 2.5 MHz | 1 MHz |\n| Slew Rate | 19 V/us | 0.8 V/us |\n| Power Supply | +/-5V to +/-40V | +/-2V to +/-18V |\n\n: TX Driver Op-Amp Options. {#tbl-tx-driver}\n\n## MIT Receive (RX) Chain {#sec-mit-rx}\n\n\n\n## RX Preamplifier (AD620) {#sec-rx-preamp}\n\nThe receive coil output (microvolts to millivolts) connects to an AD620 instrumentation amplifier. This device provides excellent common-mode rejection (100 dB minimum) and low noise (9 nV/sqrt(Hz)). Gain is set by a single resistor R~G~ according to: G = (49.4k / R~G~) + 1.\n\n| Target Gain | R~G~ Value | Notes |\n|-------------|------------|-------|\n| G = 10 | 5.49 k-ohm | Standard setting |\n| G = 100 | 499 ohm | High sensitivity |\n| G = 1000 | 49.9 ohm | Maximum gain |\n\n: AD620 Gain Resistor Selection. {#tbl-ad620-gain}\n\n## Instrumentation Amplifier (INA128) {#sec-ina128}\n\nA second gain stage uses the INA128, providing additional amplification (typically 10-100x) and further common-mode rejection. The combined gain of both stages can reach 10,000x (80 dB), sufficient to amplify microvolt signals to ADC input levels.\n\n## Signal Level Progression {#sec-signal-levels}\n\n\n\n## Lock-In Detection {#sec-lockin}\n\nLock-in detection is essential for extracting weak MIT signals from noise. The HIRT system uses **digital lock-in detection** implemented in the MCU, which offers flexibility, software configurability, and no analog drift. The technique multiplies the received signal by reference sine and cosine waveforms at the excitation frequency, then low-pass filters to extract the in-phase (I) and quadrature (Q) components.\n\n\n\nThe lock-in algorithm provides exceptional noise rejection (> 40 dB improvement) by responding only to signals at the exact reference frequency. This allows detection of MIT signals buried deep in noise, critical for weak responses from distant or low-conductivity targets.\n\n## Digital Lock-In Algorithm {#sec-lockin-algorithm}\n\n```c\n// Simplified digital lock-in implementation\nfloat I_sum = 0, Q_sum = 0;\nfor (int i = 0; i < N_samples; i++) {\n    float sample = read_adc();\n    float ref_I = sin(2 * PI * f * i / Fs);\n    float ref_Q = cos(2 * PI * f * i / Fs);\n    I_sum += sample * ref_I;\n    Q_sum += sample * ref_Q;\n}\nfloat amplitude = sqrt(I_sum*I_sum + Q_sum*Q_sum) / N_samples;\nfloat phase = atan2(Q_sum, I_sum);\n```\n\n## ERT Current Source (Howland Pump) {#sec-ert-current}\n\nThe ERT subsystem injects controlled current into the ground through electrode rings and measures the resulting voltage distribution. The current source uses a **Howland current pump** topology, which provides high output impedance (>1 M-ohm) and stable current regardless of load variations.\n\n\n\n| Parameter | Specification |\n|-----------|---------------|\n| Output Current | 0.5-2 mA (adjustable) |\n| Current Accuracy | +/- 5% |\n| Compliance Voltage | +/- 10V minimum |\n| Output Impedance | > 1 M-ohm |\n| Load Range | 100 ohm - 10 k-ohm |\n| Polarity Reversal | Programmable (0.5 Hz) |\n\n: ERT Current Source Specifications. {#tbl-ert-current}\n\n## Polarity Reversal {#sec-polarity-reversal}\n\nElectrode polarization causes measurement drift in DC systems. To mitigate this, HIRT reverses the current polarity every 2 seconds using a DPDT relay (G5V-2-H1) or solid-state switch (ADG1219). Positive and negative measurements are averaged to cancel polarization effects.\n\n\n\n## ADC Interface {#sec-adc}\n\n\n\n| Parameter | ADS1256 Specification |\n|-----------|----------------------|\n| Resolution | 24 bits |\n| Sample Rate | 30 kSPS maximum |\n| Noise | 0.6 uV RMS (at 100 SPS) |\n| Interface | SPI |\n| Internal PGA | 1, 2, 4, 8, 16, 32, 64x |\n| Input Channels | 8 single-ended or 4 differential |\n\n: ADS1256 ADC Specifications. {#tbl-adc-specs}\n\n## Multiplexer Switching {#sec-multiplexer}\n\nWith up to 24 probes in a typical array, the HIRT system requires a scalable multiplexing strategy. The design uses cascaded CD4051 8:1 analog multiplexers controlled by MCU GPIO pins. Each TX and RX signal path has its own multiplexer chain, allowing independent selection of transmit and receive probes.\n\n\n\n## Power Distribution {#sec-power}\n\n\n\n| Rail | Voltage | Current | Purpose |\n|------|---------|---------|---------|\n| +12V (Battery) | 11.1-12.6V | 200 mA total | System input |\n| +5V (LDO) | 5.0V | 50 mA | Power driver, references |\n| +3.3V (LDO) | 3.3V | 100 mA | MCU, ADC, digital |\n| -5V (Charge pump) | -5.0V | 10 mA | Op-amp negative rail |\n\n: Power Rail Specifications. {#tbl-power-rails}\n\n## Noise Filtering Stages {#sec-noise-filtering}\n\n\n\nNoise reduction is critical for MIT measurements where signal levels can be in the microvolt range. The filtering strategy employs multiple stages:\n\n- **Input RC filter (fc=100kHz):** Blocks RF interference and high-frequency EMI\n- **High-pass filter (fc=100Hz):** Removes DC offsets and 60Hz pickup\n- **Active band-pass (1-50kHz):** Passes only the measurement band\n- **Anti-aliasing filter (fc=15kHz):** Prevents aliasing in ADC sampling\n- **Digital matched filter:** Optimizes SNR in post-processing\n\n## Shielding and Ground Loop Prevention {#sec-grounding}\n\n\n\nProper grounding is essential for achieving low-noise measurements. The HIRT design follows these best practices:\n\n- **Star grounding:** All ground returns connect at a single point near the ADC\n- **Separate ground planes:** Analog and digital grounds are split on the PCB\n- **Shielded cables:** All signal cables use twisted-pair with overall shield\n- **Single-point shield termination:** Shields grounded at hub end only\n- **Minimum loop area:** Signal and return paths routed together\n\n## PCB Layout Guidelines {#sec-pcb-layout}\n\n\n\n## Layout Rules {#sec-layout-rules}\n\n1. Place bypass capacitors (100nF) within 5mm of each IC power pin\n2. Route analog signals with minimum trace length; avoid crossing digital signals\n3. Use differential pairs for RX coil signals with matched length\n4. Keep TX and RX signal paths physically separated (>10mm)\n5. Provide shielding (copper pour) around sensitive analog circuits\n6. Use wide traces (>20 mil) for power distribution\n7. Connect analog and digital ground planes at a single star point near the ADC\n\n## Key Component Summary {#sec-components}\n\n| Component | Part Number | Function | Package |\n|-----------|-------------|----------|---------|\n| DDS | AD9833BRMZ | Signal generator | MSOP-10 |\n| TX Driver | OPA454AIDDAR | Coil driver | SOIC-8 |\n| Preamp | AD620ARZ | RX preamplifier | SOIC-8 |\n| Inst Amp | INA128PAG4 | Differential amp | DIP-8 |\n| ADC | ADS1256IDBR | 24-bit ADC | SSOP-28 |\n| Multiplexer | CD4051BE | 8-channel mux | DIP-16 |\n| MCU | ESP32-WROOM-32 | Controller | Module |\n| V-Reference | REF5025AIDGKR | 2.5V reference | SOIC-8 |\n| LDO | AMS1117-3.3 | 3.3V regulator | SOT-223 |\n\n: Key IC Components. {#tbl-components}\n\n## Connector Pinouts (Probe-to-Zone) {#sec-pinouts}\n\n| Pin | Signal | Description |\n|-----|--------|-------------|\n| 1 | TX+ | To probe TX coil |\n| 2 | TX- | Return path |\n| 3 | RX+ | Differential RX |\n| 4 | RX- | Differential RX return |\n| 5 | Guard | Analog ground |\n| 6 | Ring A | Upper ERT electrode |\n| 7 | Ring B | Mid ERT electrode |\n| 8 | Ring C | Deep electrode |\n| 9 | ID Sense | Auto-ID resistor |\n| 10-11 | Spare | Reserved |\n| 12 | Shield | Cable shield clamp |\n\n: 12-pin Probe Connector Pinout. {#tbl-pinout}\n\n## Safety Considerations {#sec-safety}\n\n::: {.callout-warning}\n## ELECTRICAL SAFETY\n\n- Maximum output current limited to 5 mA by design\n- Compliance voltage restricted to +/-12V (safe for soil contact)\n- Include 10 mA fast-blow fuse on ERT output\n- Use opto-isolated relay control for polarity switching\n- Ensure proper earth ground connection for safety\n:::\n\n## Troubleshooting Guide {#sec-elec-troubleshooting}\n\n| Symptom | Likely Cause | Solution |\n|---------|--------------|----------|\n| No TX output | DDS not initialized | Check SPI connection, verify clock |\n| Weak RX signal | Gain too low | Verify R~G~ resistor, check amplifier rails |\n| Noisy readings | Ground loops | Implement star grounding, shield cables |\n| No ERT current | Open circuit | Check electrode contact, verify relay state |\n| Current drift | Reference unstable | Verify Vref output, add bypass caps |\n| ADC errors | SPI timing | Reduce SPI clock speed, check DRDY timing |\n\n: Common Issues and Solutions. {#tbl-troubleshooting}\n\n## References {#sec-electronics-references}\n\n1. Analog Devices. AD9833 Programmable Waveform Generator Data Sheet. Rev. F, 2019.\n\n2. Texas Instruments. OPA454 High-Voltage, High-Current Operational Amplifier. SBOS328D, 2018.\n\n3. Analog Devices. AD620 Low Cost, Low Power Instrumentation Amplifier. Rev. H, 2011.\n\n4. Texas Instruments. INA128 Precision, Low Power Instrumentation Amplifiers. SBOS051B, 2005.\n\n5. Texas Instruments. ADS1256 Very Low Noise, 24-Bit Analog-to-Digital Converter. SBAS288K, 2013.\n\n6. Horowitz, P. and Hill, W. The Art of Electronics, 3rd Edition. Cambridge University Press, 2015. Chapter 5: Precision Circuits.\n\n7. Ott, H.W. Electromagnetic Compatibility Engineering. Wiley, 2009. Chapter 3: Grounding.\n\n",
    "supporting": [
      "06-electronics-circuits_files/figure-pdf"
    ],
    "filters": []
  }
}