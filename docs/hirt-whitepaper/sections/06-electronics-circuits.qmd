---
title: "Electronics & Circuits"
---

## Overview {#sec-electronics-overview}

This section consolidates all circuit designs for the HIRT system, including the MIT (Magneto-Inductive Tomography) circuits, ERT (Electrical Resistivity Tomography) circuits, and base hub electronics. The design uses **centralized electronics with passive probes**: all active components reside in the surface hub, while probes contain only coils and electrodes.

This architecture offers significant advantages: lower per-probe cost, easier maintenance, better reliability (passive probes are more robust), centralized firmware updates, and simplified probe construction. The trade-off is increased cabling complexity for the multi-probe harness.

::: {.callout-tip}
## Hardware Documentation Reference

Complete circuit schematics and detailed design notes are maintained in the hardware documentation:

- **MIT Circuit:** `/hardware/schematics/electronics/mit-circuit.md` - Full TX/RX chain design with component values
- **ERT Circuit:** `/hardware/schematics/electronics/ert-circuit.md` - Howland current source and measurement circuits
- **Base Hub Circuit:** `/hardware/schematics/electronics/base-hub-circuit.md` - Central hub electronics integration
- **Block Diagrams:** `/hardware/schematics/electronics/probe-electronics-block.md` - System-level block diagrams

The diagrams in this section provide conceptual overviews; refer to the hardware schematics for exact component values and PCB layout guidance.
:::

## System Block Diagram {#sec-system-block}

```{python}
#| label: fig-system-block
#| fig-cap: "Complete HIRT system architecture showing the central electronics hub, zone wiring strategy, and passive probe connections. All signal processing occurs in the hub; probes are purely passive sensors."
#| fig-width: 11
#| fig-height: 7
#| code-fold: true

import sys; sys.path.insert(0, '..') if '..' not in sys.path else None
from diagrams.circuits import create_system_block_diagram
import matplotlib.pyplot as plt
from PIL import Image

buf = create_system_block_diagram()
img = Image.open(buf)
plt.figure(figsize=(11, 7))
plt.imshow(img)
plt.axis('off')
plt.tight_layout()
plt.show()
```

The central hub contains: (1) MCU for control and DSP, (2) MIT transmitter chain (DDS + power driver), (3) MIT receiver chain (preamp + instrumentation amplifier + ADC), (4) ERT current source and voltage measurement, and (5) high-density analog multiplexers. These connect via DB25 trunk cables to passive **Zone Hubs**, which then distribute signals to individual probes.

## MIT Transmit (TX) Chain {#sec-mit-tx}

```{python}
#| label: fig-mit-tx-chain
#| fig-cap: "MIT transmitter signal chain from MCU through DDS, filtering, and power driver to the TX coil. Operating frequency range is 2-50 kHz."
#| fig-width: 10
#| fig-height: 4
#| code-fold: true

import sys; sys.path.insert(0, '..') if '..' not in sys.path else None
from diagrams.circuits import create_mit_tx_chain
import matplotlib.pyplot as plt
from PIL import Image

buf = create_mit_tx_chain()
img = Image.open(buf)
plt.figure(figsize=(10, 4))
plt.imshow(img)
plt.axis('off')
plt.tight_layout()
plt.show()
```

## DDS Sine Generator {#sec-dds}

The transmit chain begins with a Direct Digital Synthesis (DDS) generator, the AD9833. This IC generates precise sine waves from 0.1 Hz to 12.5 MHz with 28-bit frequency resolution. For HIRT, the operating range is 2-50 kHz, with lower frequencies (2-10 kHz) preferred for deeper penetration.

| Parameter | Specification |
|-----------|---------------|
| Part Number | AD9833BRMZ |
| Frequency Range | 0.1 Hz to 12.5 MHz |
| Output Level | 0.6 V RMS sine wave |
| Interface | SPI (10 MHz max) |
| Resolution | 28-bit frequency, 12-bit phase |
| Power Supply | 2.3-5.5V, 3 mA typical |

: AD9833 DDS Generator Specifications. {#tbl-dds-specs}

## TX Power Driver {#sec-tx-driver}

The DDS output is amplified by an OPA454 or OPA2277 operational amplifier configured as a non-inverting amplifier. The gain is set by external resistors to provide 2-10x amplification, delivering 10-50 mA into the TX coil at 0-5 V RMS. The driver bandwidth (2.5 MHz) easily accommodates the operating frequency range.

| Parameter | OPA454 | OPA2277 |
|-----------|--------|---------|
| Gain (configurable) | 2-10x | 2-10x |
| Output Current | +/-2.5 A peak | +/-20 mA |
| Bandwidth | 2.5 MHz | 1 MHz |
| Slew Rate | 19 V/us | 0.8 V/us |
| Power Supply | +/-5V to +/-40V | +/-2V to +/-18V |

: TX Driver Op-Amp Options. {#tbl-tx-driver}

## MIT Receive (RX) Chain {#sec-mit-rx}

```{python}
#| label: fig-mit-rx-chain
#| fig-cap: "MIT receiver signal chain from RX coil through preamplifier, instrumentation amplifier, band-pass filter, and ADC. Total gain is approximately 1000x (60 dB). Lock-in detection extracts the signal at the reference frequency."
#| fig-width: 10
#| fig-height: 4
#| code-fold: true

import sys; sys.path.insert(0, '..') if '..' not in sys.path else None
from diagrams.circuits import create_mit_rx_chain
import matplotlib.pyplot as plt
from PIL import Image

buf = create_mit_rx_chain()
img = Image.open(buf)
plt.figure(figsize=(10, 4))
plt.imshow(img)
plt.axis('off')
plt.tight_layout()
plt.show()
```

## RX Preamplifier (AD620) {#sec-rx-preamp}

The receive coil output (microvolts to millivolts) connects to an AD620 instrumentation amplifier. This device provides excellent common-mode rejection (100 dB minimum) and low noise (9 nV/sqrt(Hz)). Gain is set by a single resistor R~G~ according to: G = (49.4k / R~G~) + 1.

| Target Gain | R~G~ Value | Notes |
|-------------|------------|-------|
| G = 10 | 5.49 k-ohm | Standard setting |
| G = 100 | 499 ohm | High sensitivity |
| G = 1000 | 49.9 ohm | Maximum gain |

: AD620 Gain Resistor Selection. {#tbl-ad620-gain}

## Instrumentation Amplifier (INA128) {#sec-ina128}

A second gain stage uses the INA128, providing additional amplification (typically 10-100x) and further common-mode rejection. The combined gain of both stages can reach 10,000x (80 dB), sufficient to amplify microvolt signals to ADC input levels.

## Signal Level Progression {#sec-signal-levels}

```{python}
#| label: fig-signal-level
#| fig-cap: "Signal level progression through the MIT RX chain. The signal starts at approximately 1 uV at the coil and is amplified to 0.8 mV at the ADC input. The noise floor also rises but at a slower rate, maintaining adequate SNR."
#| fig-width: 10
#| fig-height: 5
#| code-fold: true

import sys; sys.path.insert(0, '..') if '..' not in sys.path else None
from diagrams.circuits import create_signal_level_progression
import matplotlib.pyplot as plt
from PIL import Image

buf = create_signal_level_progression()
img = Image.open(buf)
plt.figure(figsize=(10, 5))
plt.imshow(img)
plt.axis('off')
plt.tight_layout()
plt.show()
```

## Lock-In Detection {#sec-lockin}

Lock-in detection is essential for extracting weak MIT signals from noise. The HIRT system uses **digital lock-in detection** implemented in the MCU, which offers flexibility, software configurability, and no analog drift. The technique multiplies the received signal by reference sine and cosine waveforms at the excitation frequency, then low-pass filters to extract the in-phase (I) and quadrature (Q) components.

```{python}
#| label: fig-lockin-detection
#| fig-cap: "Digital lock-in detection block diagram. The RX signal is multiplied by reference sine (Q-channel) and cosine (I-channel) signals, then filtered and integrated. Amplitude A = sqrt(I^2 + Q^2) and phase Phi = atan2(Q,I) are computed from the I/Q outputs."
#| fig-width: 10
#| fig-height: 5
#| code-fold: true

import sys; sys.path.insert(0, '..') if '..' not in sys.path else None
from diagrams.circuits import create_lock_in_detection_diagram
import matplotlib.pyplot as plt
from PIL import Image

buf = create_lock_in_detection_diagram()
img = Image.open(buf)
plt.figure(figsize=(10, 5))
plt.imshow(img)
plt.axis('off')
plt.tight_layout()
plt.show()
```

The lock-in algorithm provides exceptional noise rejection (> 40 dB improvement) by responding only to signals at the exact reference frequency. This allows detection of MIT signals buried deep in noise, critical for weak responses from distant or low-conductivity targets.

## Digital Lock-In Algorithm {#sec-lockin-algorithm}

```c
// Simplified digital lock-in implementation
float I_sum = 0, Q_sum = 0;
for (int i = 0; i < N_samples; i++) {
    float sample = read_adc();
    float ref_I = sin(2 * PI * f * i / Fs);
    float ref_Q = cos(2 * PI * f * i / Fs);
    I_sum += sample * ref_I;
    Q_sum += sample * ref_Q;
}
float amplitude = sqrt(I_sum*I_sum + Q_sum*Q_sum) / N_samples;
float phase = atan2(Q_sum, I_sum);
```

## ERT Current Source (Howland Pump) {#sec-ert-current}

The ERT subsystem injects controlled current into the ground through electrode rings and measures the resulting voltage distribution. The current source uses a **Howland current pump** topology, which provides high output impedance (>1 M-ohm) and stable current regardless of load variations.

```{python}
#| label: fig-ert-current-source
#| fig-cap: "Howland current pump circuit for ERT measurements. When R1=R2=R3=R4, the output current is I_out = V_in / R_sense, independent of load impedance. A precision 2.5V reference (REF5025) provides stable input voltage."
#| fig-width: 10
#| fig-height: 6
#| code-fold: true

import sys; sys.path.insert(0, '..') if '..' not in sys.path else None
from diagrams.circuits import create_ert_current_source
import matplotlib.pyplot as plt
from PIL import Image

buf = create_ert_current_source()
img = Image.open(buf)
plt.figure(figsize=(10, 6))
plt.imshow(img)
plt.axis('off')
plt.tight_layout()
plt.show()
```

| Parameter | Specification |
|-----------|---------------|
| Output Current | 0.5-2 mA (adjustable) |
| Current Accuracy | +/- 5% |
| Compliance Voltage | +/- 10V minimum |
| Output Impedance | > 1 M-ohm |
| Load Range | 100 ohm - 10 k-ohm |
| Polarity Reversal | Programmable (0.5 Hz) |

: ERT Current Source Specifications. {#tbl-ert-current}

## Polarity Reversal {#sec-polarity-reversal}

Electrode polarization causes measurement drift in DC systems. To mitigate this, HIRT reverses the current polarity every 2 seconds using a DPDT relay (G5V-2-H1) or solid-state switch (ADG1219). Positive and negative measurements are averaged to cancel polarization effects.

```{python}
#| label: fig-polarity-reversal
#| fig-cap: "ERT polarity reversal circuit using a DPDT relay. The relay alternates current direction between Ring A and Ring B every 2 seconds, eliminating electrode polarization artifacts from the measurement."
#| fig-width: 8
#| fig-height: 5
#| code-fold: true

import sys; sys.path.insert(0, '..') if '..' not in sys.path else None
from diagrams.circuits import create_ert_polarity_reversal
import matplotlib.pyplot as plt
from PIL import Image

buf = create_ert_polarity_reversal()
img = Image.open(buf)
plt.figure(figsize=(8, 5))
plt.imshow(img)
plt.axis('off')
plt.tight_layout()
plt.show()
```

## ADC Interface {#sec-adc}

```{python}
#| label: fig-adc-interface
#| fig-cap: "ADS1256 ADC interface showing differential analog inputs for MIT and ERT signals, SPI connection to MCU, and reference voltage. The 24-bit resolution and internal PGA provide excellent dynamic range."
#| fig-width: 9
#| fig-height: 5
#| code-fold: true

import sys; sys.path.insert(0, '..') if '..' not in sys.path else None
from diagrams.circuits import create_adc_interface_diagram
import matplotlib.pyplot as plt
from PIL import Image

buf = create_adc_interface_diagram()
img = Image.open(buf)
plt.figure(figsize=(9, 5))
plt.imshow(img)
plt.axis('off')
plt.tight_layout()
plt.show()
```

| Parameter | ADS1256 Specification |
|-----------|----------------------|
| Resolution | 24 bits |
| Sample Rate | 30 kSPS maximum |
| Noise | 0.6 uV RMS (at 100 SPS) |
| Interface | SPI |
| Internal PGA | 1, 2, 4, 8, 16, 32, 64x |
| Input Channels | 8 single-ended or 4 differential |

: ADS1256 ADC Specifications. {#tbl-adc-specs}

## Multiplexer Switching {#sec-multiplexer}

With up to 24 probes in a typical array, the HIRT system requires a scalable multiplexing strategy. The design uses cascaded CD4051 8:1 analog multiplexers controlled by MCU GPIO pins. Each TX and RX signal path has its own multiplexer chain, allowing independent selection of transmit and receive probes.

```{python}
#| label: fig-mux-switching
#| fig-cap: "Multiplexer switching topology for probe selection. Separate TX and RX multiplexers allow any TX-RX probe combination to be measured. MCU GPIO controls multiplexer address lines (A0-A2)."
#| fig-width: 10
#| fig-height: 6
#| code-fold: true

import sys; sys.path.insert(0, '..') if '..' not in sys.path else None
from diagrams.circuits import create_multiplexer_switching_diagram
import matplotlib.pyplot as plt
from PIL import Image

buf = create_multiplexer_switching_diagram()
img = Image.open(buf)
plt.figure(figsize=(10, 6))
plt.imshow(img)
plt.axis('off')
plt.tight_layout()
plt.show()
```

## Power Distribution {#sec-power}

```{python}
#| label: fig-power-distribution
#| fig-cap: "Power distribution from 12V battery through regulators to various subsystems. Total system current is approximately 200 mA, providing several hours of operation from a 3S LiPo battery."
#| fig-width: 10
#| fig-height: 5
#| code-fold: true

import sys; sys.path.insert(0, '..') if '..' not in sys.path else None
from diagrams.circuits import create_power_distribution
import matplotlib.pyplot as plt
from PIL import Image

buf = create_power_distribution()
img = Image.open(buf)
plt.figure(figsize=(10, 5))
plt.imshow(img)
plt.axis('off')
plt.tight_layout()
plt.show()
```

| Rail | Voltage | Current | Purpose |
|------|---------|---------|---------|
| +12V (Battery) | 11.1-12.6V | 200 mA total | System input |
| +5V (LDO) | 5.0V | 50 mA | Power driver, references |
| +3.3V (LDO) | 3.3V | 100 mA | MCU, ADC, digital |
| -5V (Charge pump) | -5.0V | 10 mA | Op-amp negative rail |

: Power Rail Specifications. {#tbl-power-rails}

## Noise Filtering Stages {#sec-noise-filtering}

```{python}
#| label: fig-noise-filtering
#| fig-cap: "Cascaded noise filtering stages in the signal chain. Each stage targets specific noise sources: EMI, DC offsets, wideband noise, aliasing, and quantization noise. Combined rejection exceeds 60 dB."
#| fig-width: 10
#| fig-height: 4
#| code-fold: true

import sys; sys.path.insert(0, '..') if '..' not in sys.path else None
from diagrams.circuits import create_noise_filtering_diagram
import matplotlib.pyplot as plt
from PIL import Image

buf = create_noise_filtering_diagram()
img = Image.open(buf)
plt.figure(figsize=(10, 4))
plt.imshow(img)
plt.axis('off')
plt.tight_layout()
plt.show()
```

Noise reduction is critical for MIT measurements where signal levels can be in the microvolt range. The filtering strategy employs multiple stages:

- **Input RC filter (fc=100kHz):** Blocks RF interference and high-frequency EMI
- **High-pass filter (fc=100Hz):** Removes DC offsets and 60Hz pickup
- **Active band-pass (1-50kHz):** Passes only the measurement band
- **Anti-aliasing filter (fc=15kHz):** Prevents aliasing in ADC sampling
- **Digital matched filter:** Optimizes SNR in post-processing

## Shielding and Ground Loop Prevention {#sec-grounding}

```{python}
#| label: fig-ground-loop
#| fig-cap: "Ground loop prevention techniques. (a) shows the problem: multiple ground paths create loops that pick up EMI. (b) shows the solution: star grounding with a single connection point eliminates loops."
#| fig-width: 10
#| fig-height: 5
#| code-fold: true

import sys; sys.path.insert(0, '..') if '..' not in sys.path else None
from diagrams.circuits import create_ground_loop_prevention
import matplotlib.pyplot as plt
from PIL import Image

buf = create_ground_loop_prevention()
img = Image.open(buf)
plt.figure(figsize=(10, 5))
plt.imshow(img)
plt.axis('off')
plt.tight_layout()
plt.show()
```

Proper grounding is essential for achieving low-noise measurements. The HIRT design follows these best practices:

- **Star grounding:** All ground returns connect at a single point near the ADC
- **Separate ground planes:** Analog and digital grounds are split on the PCB
- **Shielded cables:** All signal cables use twisted-pair with overall shield
- **Single-point shield termination:** Shields grounded at hub end only
- **Minimum loop area:** Signal and return paths routed together

## PCB Layout Guidelines {#sec-pcb-layout}

```{python}
#| label: fig-pcb-layout
#| fig-cap: "Recommended PCB layout showing component placement zones. The analog section (shielded) is physically separated from digital circuits. Ground plane spans the bottom layer with analog/digital split connected at a star point."
#| fig-width: 10
#| fig-height: 6
#| code-fold: true

import sys; sys.path.insert(0, '..') if '..' not in sys.path else None
from diagrams.circuits import create_component_location_diagram
import matplotlib.pyplot as plt
from PIL import Image

buf = create_component_location_diagram()
img = Image.open(buf)
plt.figure(figsize=(10, 6))
plt.imshow(img)
plt.axis('off')
plt.tight_layout()
plt.show()
```

## Layout Rules {#sec-layout-rules}

1. Place bypass capacitors (100nF) within 5mm of each IC power pin
2. Route analog signals with minimum trace length; avoid crossing digital signals
3. Use differential pairs for RX coil signals with matched length
4. Keep TX and RX signal paths physically separated (>10mm)
5. Provide shielding (copper pour) around sensitive analog circuits
6. Use wide traces (>20 mil) for power distribution
7. Connect analog and digital ground planes at a single star point near the ADC

## Key Component Summary {#sec-components}

| Component | Part Number | Function | Package |
|-----------|-------------|----------|---------|
| DDS | AD9833BRMZ | Signal generator | MSOP-10 |
| TX Driver | OPA454AIDDAR | Coil driver | SOIC-8 |
| Preamp | AD620ARZ | RX preamplifier | SOIC-8 |
| Inst Amp | INA128PAG4 | Differential amp | DIP-8 |
| ADC | ADS1256IDBR | 24-bit ADC | SSOP-28 |
| Multiplexer | CD4051BE | 8-channel mux | DIP-16 |
| MCU | ESP32-WROOM-32 | Controller | Module |
| V-Reference | REF5025AIDGKR | 2.5V reference | SOIC-8 |
| LDO | AMS1117-3.3 | 3.3V regulator | SOT-223 |

: Key IC Components. {#tbl-components}

## Connector Pinouts (Probe-to-Zone) {#sec-pinouts}

| Pin | Signal | Description |
|-----|--------|-------------|
| 1 | TX+ | To probe TX coil |
| 2 | TX- | Return path |
| 3 | RX+ | Differential RX |
| 4 | RX- | Differential RX return |
| 5 | Guard | Analog ground |
| 6 | Ring A | Upper ERT electrode |
| 7 | Ring B | Mid ERT electrode |
| 8 | Ring C | Deep electrode |
| 9 | ID Sense | Auto-ID resistor |
| 10-11 | Spare | Reserved |
| 12 | Shield | Cable shield clamp |

: 12-pin Probe Connector Pinout. {#tbl-pinout}

## Safety Considerations {#sec-safety}

::: {.callout-warning}
## ELECTRICAL SAFETY

- Maximum output current limited to 5 mA by design
- Compliance voltage restricted to +/-12V (safe for soil contact)
- Include 10 mA fast-blow fuse on ERT output
- Use opto-isolated relay control for polarity switching
- Ensure proper earth ground connection for safety
:::

## Troubleshooting Guide {#sec-elec-troubleshooting}

| Symptom | Likely Cause | Solution |
|---------|--------------|----------|
| No TX output | DDS not initialized | Check SPI connection, verify clock |
| Weak RX signal | Gain too low | Verify R~G~ resistor, check amplifier rails |
| Noisy readings | Ground loops | Implement star grounding, shield cables |
| No ERT current | Open circuit | Check electrode contact, verify relay state |
| Current drift | Reference unstable | Verify Vref output, add bypass caps |
| ADC errors | SPI timing | Reduce SPI clock speed, check DRDY timing |

: Common Issues and Solutions. {#tbl-troubleshooting}

## References {#sec-electronics-references}

1. Analog Devices. AD9833 Programmable Waveform Generator Data Sheet. Rev. F, 2019.

2. Texas Instruments. OPA454 High-Voltage, High-Current Operational Amplifier. SBOS328D, 2018.

3. Analog Devices. AD620 Low Cost, Low Power Instrumentation Amplifier. Rev. H, 2011.

4. Texas Instruments. INA128 Precision, Low Power Instrumentation Amplifiers. SBOS051B, 2005.

5. Texas Instruments. ADS1256 Very Low Noise, 24-Bit Analog-to-Digital Converter. SBAS288K, 2013.

6. Horowitz, P. and Hill, W. The Art of Electronics, 3rd Edition. Cambridge University Press, 2015. Chapter 5: Precision Circuits.

7. Ott, H.W. Electromagnetic Compatibility Engineering. Wiley, 2009. Chapter 3: Grounding.
